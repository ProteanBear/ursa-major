import React from 'react';
import Container, { ContainerLoading } from '../../components/Container';
import { Breadcrumb,Icon,Typography, Button, Divider,Col,Form,notification} from 'antd';
import { withRouter, Link } from 'react-router-dom';
import { ApplySectionPrompt, ApplySectionRecordStep } from '../../components/ApplyHeader';
import ApplyFormCommitment  from '../../components/ApplyFormCommitment';
import { ApplyStep, AppComponentProps, ApplyContentOrganization, PageError500, ApplyInspectContent} from '../../app/Model';
import { HttpResponse, HttpRequest } from '../../app/Request';
import InteractionUtils from '../../utils/InteractionUtils';
import ApplyUtils from '../../utils/ApplyUtils';
import ResourceUtils from '../../utils/ResourceUtils';

/**
 * 备案流程：第一步，承诺书
 */
class RecordCommitment extends React.Component<AppComponentProps>{
    readonly state:{
        /**申请单号 */
        serialNumber:string;
        /**保存按钮是否请求中 */
        loading:boolean;
        /**申请内容 */
        data?:ApplyContentOrganization,
    }={
        serialNumber:this.props.match.params.id,
        loading:false
    }

    /**
     * 页面布局
     */
    render(){
        const {Title}=Typography;

        //未载入数据时
        if(!this.state.data){
            return (
                <ContainerLoading />
            );
        }

        //载入数据成功后
        return (
            <Container needLogin={false}>
                {/* 标题 */}
                <Breadcrumb className="breadcrumb">
                    <Breadcrumb.Item>
                        <Link to="/public">
                            <Icon type="file-text"/>&nbsp;
                            <span>执业申请</span>
                        </Link>
                    </Breadcrumb.Item>
                    <Breadcrumb.Item><span>备案</span></Breadcrumb.Item>
                </Breadcrumb>
                <Title level={4} className="title-with-underline">备案申请</Title>

                {/* 顶部 */}
                <ApplySectionPrompt serialNumber={this.state.serialNumber} 
                    deadline={this.state.data.effectiveTimeStr} />
                <ApplySectionRecordStep {...ApplyStep.RECORD_COMMITMENT} />
                <Divider><span className="title-inner">第一步：承诺书</span></Divider>

                {/* 表单 */}
                <ApplyFormCommitment 
                    onViewGuild={this.onViewGuild}
                    serialNumber={this.state.serialNumber} 
                    organization={this.state.data} 
                    onUploadCompleted={this.uploadCompleted}
                    onRemove={this.onCommitmentRemove}
                />

                {/* 按钮 */}
                <Col span={24} className="section-buttons">
                    <Button type="primary" 
                        loading={this.state.loading}
                        disabled={""===this.state.data.commitment}
                        onClick={this.saveCommitmentAndNext}
                        >
                        保存并进入下一步
                    </Button>
                </Col>
            </Container>
        );
    }

    /**
     * 组件完成后请求获取申请信息
     */
    async componentDidMount(){
        // 获取机构申请信息
        const applyResponse=
            await ((new HttpRequest()).get<ApplyContentOrganization>(
                `webapi/apply/getRecordInfo?applyNo=${this.state.serialNumber}`
            ));

        // 失败跳转500
        if(!applyResponse.success||!applyResponse.data){
            this.props.history.push(PageError500);
            return;
        }

        // 不可编辑跳转审核结果
        const {applyStatus}=applyResponse.data;
        if(!ApplyUtils.canEdit(applyStatus)){
            this.props.history.push(ApplyStep.RECORD_RESULT.routePath(this.state.serialNumber));
            return;
        }

        // 设置显示
        this.setState({
            ...this.state,
            data:applyResponse.data
        });

        // 审核被驳回，获取驳回理由
        if(ApplyUtils.needLoadReject(applyStatus)){
            const rejectArrayResponse:HttpResponse<Array<ApplyInspectContent>>=
            await ((new HttpRequest()).get<Array<ApplyInspectContent>>(
                `webapi/apply/auditOpinion?applyNo=${this.state.serialNumber}`
            ));

            // 失败
            if(!rejectArrayResponse.success||!rejectArrayResponse.data){
                return;
            }

            // 找到最新的拒绝内容
            let rejectContent:ApplyInspectContent|null=null;
            for(let l=rejectArrayResponse.data.length,i=l-1;i>-1;i--){
                const current=rejectArrayResponse.data[i];
                if(ApplyUtils.inspectIsReject(current.status)){
                    rejectContent=current;
                    break;
                }
            }

            //通知显示拒绝理由
            if(!rejectContent) return;
            notification["warning"]({
                message:"申请被驳回！",
                description:rejectContent.opinion
            });
        }
    }

    /**
     * 告知承诺书上传完成
     */
    uploadCompleted=(url:string)=>{
        this.setState({
            ...this.state,
            data:{
                ...this.state.data,
                commitment:url
            }
        });
    }

    /**
     * 删除时处理
     */
    onCommitmentRemove=()=>{
        this.setState({
            ...this.state,
            data:{
                ...this.state.data,
                commitment:""
            }
        });
    }

    /**
     * 保存后并进入下一步
     */
    saveCommitmentAndNext=async ()=>{
        if(!this.state.data) return;
        this.setState({...this.state,loading:true});

        const saveResponse:HttpResponse<any>=
            await ((new HttpRequest()).post<any,{applyNo:string,commitment:string}>(
                "webapi/apply/saveCommitment",
                {
                    applyNo:this.state.serialNumber,
                    commitment:this.state.data.commitment
                }
            ));

        if(!saveResponse.success){
            this.props.history.push(PageError500);
        }

        this.setState({...this.state,loading:false});
        notification.destroy();
        InteractionUtils.scrollToTop();
        this.props.history.push(ApplyStep.RECORD_ORGANIZATION.routePath(this.state.serialNumber));
    }

    /**
     * 显示办事指南内容
     */
    onViewGuild=()=>{
        window.open(ResourceUtils.resource("record_guild.html"))
    }
}
export default withRouter((Form.create({name:"pageRecordCommitment"})(RecordCommitment) as any));