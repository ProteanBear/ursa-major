import 'photoswipe/dist/photoswipe.css'
import 'photoswipe/dist/default-skin/default-skin.css'

import React from 'react';
import PhotoSwipe from 'photoswipe';
import PhotoSwipeUI_Default, { Item } from 'photoswipe/dist/photoswipe-ui-default'; 

/**
 * 全屏图片查看器（基于PhotoSwipe）
 */
class ImageViewer extends React.Component{
    /**
     * 当前的查看器HTML元素
     */
    private static pswp:HTMLElement;

    /**
     * 查看指定的图片内容
     * @param items 图片数组
     * @param selectedIndex 进入后默认选择的图片索引
     */
    static view(items:Array<HTMLImageElement>,selectedIndex:number){
        if(ImageViewer.pswp){
            // 生成图片数组
            const images:Array<Item>=[];
            items.forEach(img=>{
                let sizeString=img.getAttribute("data-size");
                sizeString=(sizeString
                    ?(sizeString.indexOf("x")!==-1?sizeString:null)
                    :sizeString
                );
                const sizeArray=(sizeString
                    ?sizeString.split("x")
                    :[String(img.naturalWidth),String(img.naturalHeight)]
                );
                images.push({
                    src:img.getAttribute("data-src")||img.src,
                    w:Number(sizeArray[0]),
                    h:Number(sizeArray[1]),
                    msrc:img.src,
                    title:img.getAttribute("title")||img.getAttribute("alt")||""
                });
            });

            //构建图片查看器对象
            const photoSwipe=new PhotoSwipe(
                ImageViewer.pswp,
                PhotoSwipeUI_Default,
                images,
                {
                    closeOnScroll:false,
                    index:selectedIndex,
                    bgOpacity:0.7,
                    getThumbBoundsFn(index){
                        const img=items[index];
                        const pageYScroll = window.pageYOffset || document.documentElement.scrollTop;
                        const rect = img.getBoundingClientRect();
                        return {x:rect.left, y:rect.top + pageYScroll, w:rect.width};
                    }
                }
            );
            //自动识别data-size
            photoSwipe.listen("imageLoadComplete",(index,item)=>{
                const img=items[index];
                const sizeString=img.getAttribute("data-size");
                if(!sizeString||sizeString.indexOf("x")===-1){
                    const image=new Image();
                    image.src=img.src;
                    img.setAttribute('data-size', image.naturalWidth + 'x' + image.naturalHeight);
                    item.w = image.naturalWidth;
                    item.h = image.naturalHeight;
                    photoSwipe.invalidateCurrItems();
                    photoSwipe.updateSize(true);
                }
            });
            photoSwipe.init();
        }
    }

    /**
     * 布局内容
     */
    render(){
        return (
            <div className="pswp" tabIndex={-1} role="dialog" aria-hidden="true">
                <div className="pswp__bg"></div>
                <div className="pswp__scroll-wrap">
                    <div className="pswp__container">
                        <div className="pswp__item"></div>
                        <div className="pswp__item"></div>
                        <div className="pswp__item"></div>
                    </div>
                    <div className="pswp__ui pswp__ui--hidden">
                        <div className="pswp__top-bar">
                            <div className="pswp__counter"></div>
                            <button className="pswp__button pswp__button--close" title="Close (Esc)"></button>
                            <button className="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                            <button className="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                            <div className="pswp__preloader">
                                <div className="pswp__preloader__icn">
                                <div className="pswp__preloader__cut">
                                    <div className="pswp__preloader__donut"></div>
                                </div>
                                </div>
                            </div>
                        </div>
                        <div className="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                            <div className="pswp__share-tooltip"></div> 
                        </div>
                        <button className="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
                        </button>
                        <button className="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
                        </button>
                        <div className="pswp__caption">
                            <div className="pswp__caption__center"></div>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    /**
     * 载入后记录当前的查看器元素
     */
    componentDidMount(){
        const pswp=document.querySelector<HTMLElement>(".pswp");
        if(!pswp) return;
        ImageViewer.pswp=pswp;
    }
}
export default ImageViewer;