import React from 'react';
import Container, { ContainerLoading } from '../../components/Container';
import { Breadcrumb,Icon,Typography, Divider, message, Button, Col, Row, Form, Input, Upload, Modal, Alert } from 'antd';
import { ApplySectionPrompt, ApplySectionLicenseStep } from '../../components/ApplyHeader';
import { ApplyStep, UrlParameter, ApplyStatus, PageError500 } from '../../app/Model';
import { withRouter, RouteComponentProps, Link } from 'react-router-dom';
import { HttpRequest } from '../../app/Request';
import InteractionUtils from '../../utils/InteractionUtils';
import ApplyUtils from '../../utils/ApplyUtils';
import { UploadFile, UploadProps } from 'antd/lib/upload/interface';
import ImageViewer from '../../components/ImageViewer';

/**
 * 许可流程：第五步，审核结果
 */
class LicenseResult extends React.Component<RouteComponentProps<UrlParameter>>{
    readonly state:{
        /**申请单号 */
        serialNumber:string;
        /**申请状态数据 */
        data?:ApplyStatus|null;
        /**保存按钮是否请求中 */
        loading:boolean;
        /**文件上传验证错误 */
        hasFileValidateError:boolean;
        /**上传文件列表 */
        fileList:{
            [key:string]:Array<UploadFile>
        };
        /**上传是否成功 */
        uploadSuccess:{
            [key:string]:boolean
        };
        /**上传的数量限制 */
        uploadLimit:{
            [key:string]:number
        };
        /**弹出信息提示 */
        alert:{
            show:boolean,
            title:string,
            description:string
        };
        /**是否填写了社会统一信用代码 */
        codeAdded:boolean;
    }={
        serialNumber:this.props.match.params.id,
        loading:false,
        hasFileValidateError:false,
        fileList:{
            "license":[],
        },
        uploadSuccess:{
            "license":true,
        },
        uploadLimit:{
            "license":20,
        },
        alert:{show:false,title:"",description:""},
        codeAdded:false,
    }

    /**
     * 上传组件配置：图片
     */
    private readonly uploadPhotoConfig:UploadProps={
        accept:".jpg,.png",
        listType:"picture-card",
        className:"avatar-uploader",
        showUploadList:true,
    }

    /**
     * 页面布局
     */
    render(){
        //未载入数据时
        if(!this.state.data){
            return (
                <ContainerLoading />
            );
        }

        const {Title,Text}=Typography;
        const {status,orgName,createTime,refuse,licenseUploaded,onlyCode}=this.state.data;

        return (
            <Container needLogin={false}>
                {/* 标题 */}
                <Breadcrumb className="breadcrumb">
                    <Breadcrumb.Item>
                        <Link to="/public">
                            <Icon type="file-text"/>&nbsp;
                            <span>执业申请</span>
                        </Link>
                    </Breadcrumb.Item>
                    <Breadcrumb.Item><span>许可</span></Breadcrumb.Item>
                </Breadcrumb>
                <Title level={4} className="title-with-underline">许可申请</Title>

                {/* 顶部 */}
                <ApplySectionPrompt serialNumber={this.state.serialNumber} 
                    deadline={this.state.data.applyValidDate} />
                <ApplySectionLicenseStep {...ApplyStep.LICENSE_RESULT} />
                <Divider><span className="title-inner">审核结果</span></Divider>

                {/* 内容 */}
                {
                    // 审核通过
                    ApplyUtils.agree(status)
                    ?(
                        // 补充资料
                        ApplyUtils.canSupplement(status)
                        ?(
                            ApplyUtils.supplementReject(status)
                            // 补充资料被驳回
                            ?(
                                <section className="apply-result">
                                    <Icon type="check-circle" theme="filled" className="failure"/>
                                    <Title level={4}>申请失败</Title>
                                    <p><Text type="secondary">对不起！您的补充资料被驳回！</Text></p>
                                    <Row>
                                        <Col span={8} offset={8} className="instruction">
                                            <p>机构名称：{orgName}</p>
                                            <p>申请日期：{createTime}</p>
                                            <p>处理状态：<span className="stress">补充资料被驳回</span></p>
                                            <p>驳回理由：{refuse}</p>
                                        </Col>
                                    </Row>
                                    <p className="button-group">
                                        <Button type="primary" className="button" onClick={this.toSupplement}>重新编辑</Button>
                                    </p>
                                </section>
                            )
                            // 补充资料
                            :(
                                <section className="apply-result">
                                    <Icon type="check-circle" theme="filled" className="success"/>
                                    <Title level={4}>申请成功</Title>
                                    <Text type="secondary">您的备案申请已通过，可以进行资料补充！</Text>
                                    <p className="button-group">
                                        <Button className="button" onClick={this.download}>下载临时电子证</Button>
                                        <Button type="primary" className="button" onClick={this.toSupplement}>补充资料</Button>
                                    </p>

                                    <Col span={14} offset={5} className="instruction">
                                        <p className="title"><Text type="secondary">关于补充资料</Text></p>
                                        <p>
                                            <Text type="secondary">您可以下载临时电子证用来签订需有许可证才可签订的相关合同（如污水处理方案），签订后补充提交相关合同的照片。</Text>
                                        </p>
                                    </Col>
                                </section>
                            )
                        )
                        :(
                            // 补充资料审核中
                            (ApplyUtils.supplementChecking(status))
                            ?(
                                <section className="apply-result">
                                <Icon type="clock-circle" theme="filled"/>
                                <Title level={4}>审核中</Title>
                                <p><Text type="secondary"></Text></p>
                                <Row>
                                    <Col span={6} offset={9} className="instruction">
                                        <p>机构名称：{orgName}</p>
                                        <p>申请日期：{createTime}</p>
                                        <p>处理状态：<span className="stress">补充资料审核中</span></p>
                                    </Col>
                                </Row>
                                <Row>
                                    <Col span={12} offset={6} className="instruction">
                                        <p className="title"><Text type="secondary">跟踪审核情况</Text></p>
                                        <p>
                                            <Text type="secondary">当处理状态出现变动时，我们会随时短信通知您。也可以<Button type="link" onClick={this.attention}>关注高新公众号</Button>，随时查看办事进度。</Text>
                                        </p>
                                    </Col>
                                </Row>
                            </section>
                            )
                            // 已完成
                            :(
                                <section className="apply-result">
                                    <Icon type="check-circle" theme="filled" className="success"/>
                                    <Title level={4}>申请成功</Title>
                                    <Text type="secondary">您的备案申请已通过！</Text>
                                    <p className="button-group">
                                        <Button type="primary" className="button" onClick={this.download}>下载电子证</Button>
                                        <Button className="button" onClick={this.toLogin}>登录系统</Button>
                                    </p>

                                    <Col span={14} offset={5} className="instruction">
                                        <p className="title"><Text type="secondary">关于登录系统</Text></p>
                                        <p>
                                            <Text type="secondary">申请成功后系统已经为您生成了登录账号，请牢记你的账号。并通过短信发送的登录密码登录到系统，就可以对机构信息进行维护。</Text>
                                            <Text type="secondary">短信没收到？<Button type="link" onClick={this.reSend}>重新发送</Button>！</Text>
                                        </p>
                                        <p className="title"><Text type="secondary">关于现场领证</Text></p>
                                        <p><Text type="secondary">请携带机构相关证件原件及人员的身份证...【未完】。</Text></p>
                                    </Col>
                                </section>
                            )
                        )
                    )
                    // 被驳回
                    :(ApplyUtils.canEdit(status)?(
                        <section className="apply-result">
                            <Icon type="check-circle" theme="filled" className="failure"/>
                            <Title level={4}>申请失败</Title>
                            <p><Text type="secondary">对不起！您的备案申请被驳回！</Text></p>
                            <Row>
                                <Col span={8} offset={8} className="instruction">
                                    <p>机构名称：{orgName}</p>
                                    <p>申请日期：{createTime}</p>
                                    <p>处理状态：<span className="stress">审核未通过</span></p>
                                    <p>驳回理由：{refuse}</p>
                                </Col>
                            </Row>
                            <p className="button-group">
                                <Button type="primary" className="button" onClick={this.edit}>重新编辑</Button>
                            </p>
                        </section>
                    )
                    :(
                        ApplyUtils.canSite(status)
                        // 申请现场核验
                        ?(
                            <section className="apply-result">
                                <Icon type="clock-circle" theme="filled"/>
                                <Title level={4}>等待现场验收</Title>
                                <Text type="secondary">您的备案申请已通过公示，可以申请现场验收！</Text>
                                
                                {/* 补充营业执照 */}
                                {licenseUploaded===0||!this.state.codeAdded?(
                                    <div style={{marginTop:20,textAlign:"left"}}>
                                        <Row>
                                            <Col span={10} offset={7}>
                                                <Form labelCol={{span:8}} wrapperCol={{span:16}}>
                                                    {this.state.codeAdded?null:(
                                                        <Form.Item hasFeedback 
                                                            label="统一社会信用代码" className="must-upload" 
                                                            validateStatus={this.state.data.onlyCode.length>17?undefined:"error"}
                                                            help={this.state.data.onlyCode.length>17?"":"统一社会信用代码不能少于18位！"}
                                                        >
                                                            <Input placeholder="请输入" 
                                                                value={onlyCode}
                                                                onChange={event=>this.setState({...this.state,data:{...this.state.data,onlyCode:event.target.value}})}
                                                            />
                                                        </Form.Item>
                                                    )}
                                                    {licenseUploaded!==0?null:(
                                                        <Form.Item className="license-photos must-upload"
                                                            label="营业执照" 
                                                            validateStatus={
                                                                !this.state.hasFileValidateError
                                                                    ?(this.state.uploadSuccess.license?"":"error")
                                                                    :(this.state.fileList.license.length>0?"":"error")
                                                            }
                                                            help={
                                                                !this.state.hasFileValidateError
                                                                    ?(this.state.uploadSuccess.license?"支持扩展名：.jpg .png":"图片上传失败！")
                                                                    :(this.state.fileList.license.length>0?"支持扩展名：.jpg .png":"必须上传此图片！")
                                                            }
                                                        >
                                                            <Upload {...this.uploadPhotoConfig}
                                                                name="license"
                                                                customRequest={(fileObject:object)=>{
                                                                    this.uploadFileOrPhoto(fileObject,"license");
                                                                }}
                                                                onRemove={(file:UploadFile)=>{
                                                                    this.uploadFileOrPhotoRemove(file,"license")
                                                                }}
                                                                onPreview={(file:UploadFile)=>{
                                                                    this.uploadPhotoPreview(file,"license")
                                                                }}
                                                                fileList={this.state.fileList.license}
                                                                disabled={this.state.loading}
                                                            >
                                                                {this.state.uploadLimit.license>this.state.fileList.license.length
                                                                ?(
                                                                    <div>
                                                                        <Icon type="plus" />
                                                                        <div className="ant-upload-text">上传</div>
                                                                    </div>
                                                                )
                                                                :null}
                                                            </Upload>
                                                        </Form.Item>
                                                    )}
                                                </Form>
                                            </Col>
                                        </Row>
                                        {/* 提示信息 */}
                                        {(this.state.alert.show)?(
                                            <Col span={12} offset={6} style={{marginTop:10}}>
                                                <Alert 
                                                    message={this.state.alert.title}
                                                    description={this.state.alert.description}
                                                    type="error" showIcon
                                                />
                                            </Col>
                                        ):null}
                                        <Row>
                                            <Col span={10} offset={7}>
                                                <Col span={16} offset={8}>
                                                    <Button type="primary" className="button" 
                                                        onClick={this.submitSupplyment}
                                                        loading={this.state.loading}
                                                        disabled={""===onlyCode||(licenseUploaded===0&&this.state.fileList.license.length===0)}
                                                    >
                                                        申请现场验收
                                                    </Button>
                                                </Col>
                                            </Col>
                                        </Row>
                                    </div>
                                // 无需补充
                                ):(
                                    <div>
                                        {(this.state.alert.show)?(
                                            <Col span={12} offset={6} style={{marginTop:10}}>
                                                <Alert 
                                                    message={this.state.alert.title}
                                                    description={this.state.alert.description}
                                                    type="error" showIcon
                                                />
                                            </Col>
                                        ):null}
                                        <p className="button-group">
                                            <Button type="primary" className="button" 
                                                onClick={this.submitSupplyment}
                                                loading={this.state.loading}
                                            >
                                                申请现场验收
                                            </Button>
                                        </p>
                                    </div>
                                    
                                )}

                                <Row>
                                    <Col span={12} offset={6} className="instruction">
                                        <p className="title"><Text type="secondary">跟踪审核情况</Text></p>
                                        <p>
                                            <Text type="secondary">当处理状态出现变动时，我们会随时短信通知您。也可以<Button type="link" onClick={this.attention}>关注高新公众号</Button>，随时查看办事进度。</Text>
                                        </p>
                                    </Col>
                                </Row>
                            </section>
                        )
                        // 申请中
                        :(
                            <section className="apply-result">
                                <Icon type="clock-circle" theme="filled"/>
                                <Title level={4}>审核中</Title>
                                <p><Text type="secondary"></Text></p>
                                <Row>
                                    <Col span={6} offset={9} className="instruction">
                                        <p>机构名称：{orgName}</p>
                                        <p>申请日期：{createTime}</p>
                                        <p>处理状态：<span className="stress">审核中</span></p>
                                    </Col>
                                </Row>
                                <Row>
                                    <Col span={12} offset={6} className="instruction">
                                        <p className="title"><Text type="secondary">跟踪审核情况</Text></p>
                                        <p>
                                            <Text type="secondary">当处理状态出现变动时，我们会随时短信通知您。也可以<Button type="link" onClick={this.attention}>关注高新公众号</Button>，随时查看办事进度。</Text>
                                        </p>
                                    </Col>
                                </Row>
                            </section>
                        )
                    ))
                }
            </Container>
        );
    }

    /**
     * 组件载入后，载入数据信息
     */
    componentDidMount(){
        this.loadApplyStatus();
    }

    /**
     * 载入申请状态
     */
    loadApplyStatus=async ()=>{
        //获取申请状态信息
        const applyStatusResponse=await ((new HttpRequest()).get<ApplyStatus>(
            `webapi/apply/queryStatus?applyNo=${this.state.serialNumber}`
        ));

        // 失败跳转500
        if(!applyStatusResponse.success||!applyStatusResponse.data){
            this.props.history.push(PageError500);
            return;
        }

        // 设置显示
        this.setState({
            ...this.state,
            data:applyStatusResponse.data,
            codeAdded:applyStatusResponse.data.onlyCode!==""
        });
    }

    /**
     * 重新编辑
     */
    edit=()=>{
        InteractionUtils.scrollToTop();
        this.props.history.push(ApplyStep.LICENSE_COMMITMENT.routePath(this.state.serialNumber));
    }

    /**
     * 下载电子证
     */
    download=()=>{
        if(!this.state.data) return;
        window.open(this.state.data.eCert);
    }

    /**
     * 系统登录
     */
    toLogin=()=>{
        InteractionUtils.scrollToTop();
        this.props.history.push("/");
    }

    /**
     * 补充资料
     */
    toSupplement=()=>{
        InteractionUtils.scrollToTop();
        this.props.history.push(ApplyStep.LICENSE_SUPPLYMENT.routePath(this.state.serialNumber));
    }

    /**
     * 重新发送
     */
    reSend=()=>{
        message.warning("此功能正在开发中...");
    }

    /**
     * 关注公众号
     */
    attention=()=>{
        message.warning("此功能正在开发中...");
    }

    /**
     * 上传文件或者图片
     */
    uploadFileOrPhoto=async (fileObject:object,key:string)=>{
        // 上传文件或图片
        const option=fileObject as {file:File};
        const uploadResponse=await (new HttpRequest())
            .upload<{url:string},{applyNo:string}>
            (
                `webapi/comm/uploadFile`,
                option.file,
                "file",
                {applyNo:this.state.serialNumber}
            );
        const {uploadSuccess}=this.state;
        uploadSuccess[key]=(uploadResponse.success&&(uploadResponse.data!==null));
        
        //上传失败显示
        if(!uploadSuccess[key]||!uploadResponse.data){
            this.setState({
                ...this.state,
                uploadSuccess:uploadSuccess
            });
            return;
        }

        //上传成功，设置已上传列表
        const {fileList}=this.state;
        fileList[key].push({
            uid:String(fileList[key].length),
            name:option.file.name,
            size:0,
            type:"",
            url:uploadResponse.data.url
        });
        this.setState({
            ...this.state,
            uploadSuccess:uploadSuccess,
            saved:false,
            fileList:fileList
        });
    }

    /**
     * 全屏查看上传的图片
     */
    uploadPhotoPreview=(uploadFile:UploadFile,key:string)=>{
        // 获取全部上传的图片元素
        const row=document.querySelector<HTMLDivElement>(`.${key}-photos`);
        if(!row) return;
        const imgArray=row.querySelectorAll<HTMLImageElement>
            (".ant-upload-list-item-image");
        const imageList:Array<HTMLImageElement>=[];

        let currentIndex=0;
        imgArray.forEach((img,index)=>{
            imageList.push(img);
            currentIndex=(index===Number(uploadFile.uid)?index:currentIndex);
        });

        ImageViewer.view(imageList,currentIndex);
    }

    /**
     * 删除上传的文件或图片
     */
    uploadFileOrPhotoRemove=(file:UploadFile,key:string)=>{
        const {confirm}=Modal;
        const {fileList}=this.state;
        confirm({
            title: '确定要删除当前上传的文件或图片么？',
            okText: '继续删除',
            okType: 'danger',
            cancelText: '取消',
            onOk:()=>{
                fileList[key].splice(fileList[key].findIndex(item=>item.uid===file.uid),1);
                this.setState({
                    ...this.state,
                    saved:false,
                    fileList:fileList
                });
            },
        });
    }

    /**
     * 提交现场核验申请
     */
    submitSupplyment=async ()=>{
        const {data,fileList}=this.state;
        if(!data) return;

        // 验证统一社会信用代码长度
        if(data.onlyCode.length<18){
            return;
        }

        //提交申请
        this.setState({
            ...this.state,
            loading:true,
            alert:{...this.state.alert,show:false}
        });
        const submitResponse=await ((new HttpRequest()).post<any>(
            "webapi/apply/saveSupplementInfo",{
                applyNo:this.state.serialNumber,
                onlyCode:data.onlyCode,
                businessLicense:ApplyUtils.uploadArrayToUrlString(fileList.license),
            }
        ));

        // 失败跳转500
        if(!submitResponse.success){
            this.setState({
                ...this.state,
                loading:false,
                alert:{
                    show:true,
                    title:"申请失败",
                    description:submitResponse.message
                }
            });
            return;
        }

        // 设置显示
        this.setState({
            ...this.state,
            loading:false,
            data:null,
        });
        this.loadApplyStatus();
    }
}
export default withRouter(LicenseResult);