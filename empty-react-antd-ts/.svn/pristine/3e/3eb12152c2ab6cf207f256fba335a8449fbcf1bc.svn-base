import React, { CSSProperties } from 'react';
import {Col,Checkbox} from 'antd';

import { DictionaryData, DictionaryLoader } from '../app/DictionaryLoader';
import ApplyUtils from '../utils/ApplyUtils';
import { CheckboxChangeEvent } from 'antd/lib/checkbox';

/**
 * 诊疗范围类型（全部、简略）
 */
export enum ApplyFormMedicalType{
    FULL,SIMPLE
}

/**
 * 诊疗范围环境变量
 */
export const ApplyFormMedicalTypeContext=React.createContext<{type:ApplyFormMedicalType}>({
    type:ApplyFormMedicalType.SIMPLE
})

/**
 * 传递属性
 */
type ApplyFormMedicalProps={
    /**诊疗范围选中，多个之间逗号分隔 */
    scope:string;
    /**诊疗范围变化后的修改事件 */
    onChange(selectedScope:string):void;
    /**是否禁止输入 */
    disabled:boolean;
}

/**
 * 申请公用表单：诊疗范围
 */
 export class ApplyFormMedical extends React.Component<ApplyFormMedicalProps>{
    readonly state:{
        /**已选中的全部诊疗范围 */
        selectedCodes:Set<string>
    }={
        selectedCodes:ApplyUtils.medicalScopeToSet(this.props.scope)
    }
    
    /**
     * 页面布局
     */
    render(){
        const firstTitleStyle:CSSProperties={fontSize:16,fontWeight:"bold"};

        return (
            <section>
                <ApplyFormMedicalTypeContext.Consumer>
                    {({type})=>{
                        const medical:Array<DictionaryData>=(
                            type===ApplyFormMedicalType.SIMPLE
                                ?DictionaryLoader.instance.medicalSimple()
                                :DictionaryLoader.instance.medical()
                        );
                        return (
                            <ul className="form-ul-group">
                               {
                                    medical.map((dict:DictionaryData)=>{
                                        return dict.children&&dict.children.length>0
                                        ?(
                                            <li>
                                                <Col span={4}>
                                                    <Checkbox
                                                        value={dict.value}
                                                        style={{marginTop:8}}
                                                        checked={this.state.selectedCodes.has(dict.value||"")}
                                                        onChange={this.onCheckboxChange}
                                                        disabled={this.props.disabled}
                                                    >
                                                        <span style={firstTitleStyle}>{dict.label}</span>
                                                    </Checkbox>
                                                </Col>
                                                <Col span={20}>
                                                    {dict.children.map((childDict:DictionaryData)=>(
                                                        <Col span={6}>
                                                            <Checkbox
                                                                value={childDict.value}
                                                                style={{marginTop:11}}
                                                                checked={this.state.selectedCodes.has(childDict.value||"")}
                                                                onChange={this.onCheckboxChange}
                                                                disabled={this.props.disabled}
                                                            >
                                                                {childDict.label}
                                                            </Checkbox>
                                                        </Col>
                                                    ))}
                                                </Col>
                                            </li>
                                        ):(
                                            <li>
                                                <Col span={24}>
                                                    <Checkbox
                                                        value={dict.value}
                                                        style={{marginTop:8}}
                                                        checked={this.state.selectedCodes.has(dict.value||"")}
                                                        onChange={this.onCheckboxChange}
                                                        disabled={this.props.disabled}
                                                    >
                                                        <span style={firstTitleStyle}>{dict.label}</span>
                                                    </Checkbox>
                                                </Col>
                                            </li>
                                        );
                                    })
                               } 
                            </ul>
                        );
                    }}
                </ApplyFormMedicalTypeContext.Consumer>
            </section>
        );
    }

    /**
     * 选择改变事件：
     * 修改当前选择的内容Set，
     * 并同步给父组件
     */
    onCheckboxChange=(event:CheckboxChangeEvent)=>{
        const {checked,value}=event.target;
        const {selectedCodes}=this.state;
        checked?selectedCodes.add(value):selectedCodes.delete(value);

        // 选择子项自动加上父项
        const parentCode=ApplyUtils.medicalScopeParentCode(value);
        if(parentCode&&checked) selectedCodes.add(parentCode);
        
        this.setState({
            ...this.state,
            selectedCodes:selectedCodes
        });

        this.props.onChange(
            ApplyUtils.medicalScopeToString(this.state.selectedCodes)
        );
    }
 }